var async, dialog, fs, fstream, log, pack, path, request, tar;

pack = require('../package.json');

request = require('superagent');

dialog = require('commander');

path = require('path');

log = require('./logger');

tar = require('tar');

async = require('async');

fs = require('fs');

fstream = require('fstream');

/*
Returns the montent of maxmertkit.json file
*/


exports.maxmertkit = function() {
  var json, rawjson;
  rawjson = fs.readFileSync(path.join('.', pack.maxmertkit));
  if (!(rawjson != null)) {
    log.error("couldn\'t read " + pack.maxmertkit + " file.");
    return process.stdin.destroy();
  } else {
    return json = JSON.parse(rawjson);
  }
};

/*
Initializing new widget or theme in current directory
*/


exports.init = function(options) {
  var types,
    _this = this;
  types = ['widget', 'theme'];
  return async.series({
    type: function(callback) {
      return dialog.choose(types, function(i) {
        return callback(null, types[i]);
      });
    },
    name: function(callback) {
      var defaultPkgName;
      defaultPkgName = 'test';
      return dialog.prompt("name: (test) ", function(pkgName) {
        if (pkgName === '') {
          pkgName = defaultPkgName;
        }
        return callback(null, pkgName);
      });
    },
    version: function(callback) {
      var defaultVersion;
      defaultVersion = '0.0.0';
      return dialog.prompt("version: (0.0.0) ", function(version) {
        if (version === '') {
          version = defaultVersion;
        }
        return callback(null, version);
      });
    },
    description: function(callback) {
      return dialog.prompt("description: ", function(description) {
        return callback(null, description);
      });
    },
    repository: function(callback) {
      return dialog.prompt("repository: ", function(repository) {
        return callback(null, repository);
      });
    },
    author: function(callback) {
      return dialog.prompt("author: ", function(author) {
        return callback(null, author);
      });
    },
    license: function(callback) {
      var defaultLicense;
      defaultLicense = 'BSD';
      return dialog.prompt("license: (BSD) ", function(license) {
        if (license === '') {
          license = defaultLicense;
        }
        return callback(null, license);
      });
    }
  }, function(err, maxmertkitjson) {
    return _this.writeConfirm(maxmertkitjson, options);
  });
};

/*
Confirm writing json to the maxmertkit.json file
*/


exports.writeConfirm = function(json, options) {
  var _this = this;
  return dialog.confirm("Is everything correct? \n\n " + (JSON.stringify(json, null, 4)) + "\n-> ", function(ok) {
    console.log("");
    if (!ok) {
      log.error("Initializing canceled");
      return process.stdin.destroy();
    } else {
      return fs.exists(pack.maxmertkit, function(exists) {
        if (!exists) {
          _this.write(json, options);
          return process.stdin.destroy();
        } else {
          log.error("File " + pack.maxmertkit + " already exists.");
          return dialog.confirm("Do you want to overwrite it? -> ", function(ok) {
            if (!ok) {
              log.error("initialization canceled.");
              return process.stdin.destroy();
            } else {
              _this.write(json, options);
              return process.stdin.destroy();
            }
          });
        }
      });
    }
  });
};

/*
Writing json to the maxmertkit.json file
*/


exports.write = function(json, options) {
  return fs.writeFile(pack.maxmertkit, JSON.stringify(json, null, 4), function(err) {
    if (err) {
      log.error("initializing â€“ " + err + ".");
    }
    return log.success("file " + pack.maxmertkit + " successfully created.");
  });
};

/*
Packing widget or theme in current folder. The folders name should be the same as your package name in maxmertkit.json
*/


exports.pack = function(options, callback) {
  var fileName, maxmertkitjson,
    _this = this;
  maxmertkitjson = this.maxmertkit();
  if (path.basename(path.resolve('.')) === ("" + maxmertkitjson.name)) {
    fileName = "" + maxmertkitjson.name + "@" + maxmertkitjson.version + ".tar";
    return fstream.Reader({
      type: "Directory",
      path: '.'
    }).pipe(tar.Pack({})).on('error', function(err) {
      log.error('Failed to create package.');
      if (!(callback != null)) {
        return process.stdin.destroy();
      } else {
        return callback(err, fileName);
      }
    }).pipe(fstream.Writer(path.join('/tmp/', fileName)).on("close", function() {
      log.success("Finished to create package");
      if (!(callback != null)) {
        return _this.restore(fileName, callback);
      } else {
        return callback(null, fileName);
      }
    }));
  } else {
    return log.error("The folders name (" + (path.basename(path.resolve('.'))) + ") should be the same as your package name in maxmertkit.json (" + maxmertkitjson.name + ").");
  }
};

/*
Restore package from /tmp folder to the current folder
*/


exports.restore = function(fileName, callback) {
  return fs.readFile(path.join('/tmp/', fileName), function(err, data) {
    if (err != null) {
      log.error("Failed to restore " + fileName + " from /tmp folder. Maybe there is no such file or folder.");
      if (!(callback != null)) {
        return process.stdin.destroy();
      } else {
        return callback(err, fileName);
      }
    } else {
      return fs.writeFile(path.join('.', fileName), data, function(err) {
        if (err != null) {
          log.error("Failed to restore " + fileName + " from /tmp folder. Maybe you do not have permissions to write in current folder.");
          if (!(callback != null)) {
            return process.stdin.destroy();
          } else {
            return callback(err, fileName);
          }
        } else {
          log.success("Finished to restore package");
          if (!(callback != null)) {
            return process.stdin.destroy();
          } else {
            return callback(null, fileName);
          }
        }
      });
    }
  });
};

/*
Check if widget or theme is exists
*/


exports.onServerIsExists = function(options, callback) {
  var widget;
  widget = this.maxmertkit();
  return request.get("" + pack.homepage + "/widgets/" + widget.name).set('X-Requested-With', 'XMLHttpRequest').end(function(res) {
    if (res.ok && res.status !== 500 && res.status !== 404) {
      if (res.body.done) {
        log.success("widget with name " + widget.name + " exists.");
        if (!(callback != null)) {
          return process.stdin.destroy();
        } else {
          return callback(null, fileName);
        }
      } else {
        log.error("widget with name " + widget.name + " does not exists.");
        if (!(callback != null)) {
          return process.stdin.destroy();
        } else {
          return callback(true, fileName);
        }
      }
    }
  });
};
